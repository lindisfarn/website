---
/**
 * TheLedger â€” Act VI
 * Contact form section with Zoho Forms integration
 */
import { getTranslations } from '../i18n/utils';
import { getLocaleFromPath } from '../i18n/config';

// Get locale from prop or URL
const { lang } = Astro.props;
const currentLocale = lang || getLocaleFromPath(Astro.url.pathname);
const t = getTranslations(currentLocale);
const isFrench = currentLocale === 'fr';

// Localized links
const privacyLink = isFrench ? '/fr/confidentialite' : '/privacy';
const termsLink = isFrench ? '/fr/conditions' : '/terms';
const redirectUrl = isFrench ? '/fr/merci' : '/thank-you';
---

<section 
  id="ledger" 
  class="relative py-24 md:py-32 bg-[#F2F0E9]"
>
  <!-- Background -->
  <div class="absolute inset-0 z-0">
    <img 
      src="/fields.png" 
      alt=""
      class="w-full h-full object-cover opacity-10"
      aria-hidden="true"
    />
    <div class="absolute inset-0 bg-gradient-to-b from-[#F2F0E9] via-[#F2F0E9]/90 to-[#F2F0E9]"></div>
  </div>

  <!-- Content -->
  <div class="relative z-10 max-w-xl mx-auto px-6">
    <h3 class="text-center font-['Cormorant_Garamond',serif] text-3xl md:text-4xl lg:text-5xl text-[#2B2B2B] mb-4">
      {t.ledger.title}
    </h3>
    
    <p class="text-center font-['EB_Garamond',serif] text-lg md:text-xl text-[#4A5A66] leading-relaxed mb-10">
      {t.ledger.p1}
    </p>
    
    <!-- Contact Form -->
    <form 
      id="contact-form"
      action="https://forms.zohopublic.ca/lindisfarn1/form/Subscribe2026FirstQuarter/formperma/GR5ToUGaOPu7XO8jK7Lb-xBby74W2lhsV8wNSBraXMg/htmlRecords/submit"
      method="POST"
      accept-charset="UTF-8"
      enctype="multipart/form-data"
      class="space-y-6"
      data-redirect-url={redirectUrl}
    >
      <input type="hidden" name="zf_referrer_name" value="">
      <input type="hidden" name="zc_gad" value="">
      
      <!-- Name Fields -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block font-['JetBrains_Mono',monospace] text-xs tracking-wider text-[#4A5A66] mb-2 uppercase">
            {t.ledger.form.firstName}
          </label>
          <input 
            type="text" 
            name="Name_First" 
            maxlength="255"
            required
            class="w-full px-4 py-3 bg-white border border-[#2B2B2B]/20 rounded-lg font-['EB_Garamond',serif] text-lg text-[#2B2B2B] focus:outline-none focus:border-[#C8A97E] focus:ring-2 focus:ring-[#C8A97E]/20 transition-colors"
          />
        </div>
        <div>
          <label class="block font-['JetBrains_Mono',monospace] text-xs tracking-wider text-[#4A5A66] mb-2 uppercase">
            {t.ledger.form.lastName}
          </label>
          <input 
            type="text" 
            name="Name_Last" 
            maxlength="255"
            required
            class="w-full px-4 py-3 bg-white border border-[#2B2B2B]/20 rounded-lg font-['EB_Garamond',serif] text-lg text-[#2B2B2B] focus:outline-none focus:border-[#C8A97E] focus:ring-2 focus:ring-[#C8A97E]/20 transition-colors"
          />
        </div>
      </div>
      
      <!-- Email -->
      <div>
        <label class="block font-['JetBrains_Mono',monospace] text-xs tracking-wider text-[#4A5A66] mb-2 uppercase">
          {t.ledger.form.email}
        </label>
        <input 
          type="email" 
          name="Email" 
          maxlength="255"
          required
          class="w-full px-4 py-3 bg-white border border-[#2B2B2B]/20 rounded-lg font-['EB_Garamond',serif] text-lg text-[#2B2B2B] focus:outline-none focus:border-[#C8A97E] focus:ring-2 focus:ring-[#C8A97E]/20 transition-colors"
        />
      </div>
      
      <!-- Message -->
      <div>
        <label class="block font-['JetBrains_Mono',monospace] text-xs tracking-wider text-[#4A5A66] mb-2 uppercase">
          {t.ledger.form.message}
        </label>
        <textarea 
          name="MultiLine" 
          maxlength="65535"
          rows="4"
          required
          class="w-full px-4 py-3 bg-white border border-[#2B2B2B]/20 rounded-lg font-['EB_Garamond',serif] text-lg text-[#2B2B2B] focus:outline-none focus:border-[#C8A97E] focus:ring-2 focus:ring-[#C8A97E]/20 transition-colors resize-none"
          placeholder={t.ledger.form.messagePlaceholder}
        ></textarea>
      </div>
      
      <!-- Submit Button -->
      <div class="text-center pt-2">
        <button 
          type="submit"
          id="submit-btn"
          class="inline-block px-10 py-4 bg-[#2B2B2B] text-[#F2F0E9] font-['JetBrains_Mono',monospace] text-sm tracking-[0.2em] uppercase hover:bg-[#C8A97E] hover:text-[#1a1a1a] transition-colors duration-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {t.ledger.form.submit}
        </button>
      </div>
    </form>

    <script>
      const form = document.getElementById('contact-form') as HTMLFormElement;
      const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
      
      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Use localized redirect URL from data attribute
        const redirectUrl = form.dataset.redirectUrl || '/thank-you';

        // Track with Meta Pixel
        if (typeof (window as any).fbq !== 'undefined') {
          (window as any).fbq('track', 'Contact', {content_name: 'Contact Form Submission'});
        }
        
        // Disable button and show loading state
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = 'Sending...';
        }
        
        try {
          const formData = new FormData(form);
          
          // Submit to Zoho (no-cors mode since Zoho doesn't return CORS headers)
          await fetch(form.action, {
            method: 'POST',
            body: formData,
            mode: 'no-cors'
          });
          
          // Redirect
          window.location.href = redirectUrl;
        } catch (error) {
          console.error('Form submission error:', error);
          // Still redirect
          window.location.href = redirectUrl;
        }
      });
    </script>
  </div>
  
  <!-- Footer -->
  <footer class="relative z-10 mt-24 py-16 text-center border-t border-[#2B2B2B]/10">
    <p class="font-['Cormorant_Garamond',serif] text-2xl italic text-[#4A5A66]">
      {t.footer.motto}
    </p>

    <div class="flex justify-center gap-6 mt-8">
      <a href={privacyLink} class="text-[#4A5A66] text-xs font-['JetBrains_Mono',monospace] hover:text-[#C8A97E] transition-colors">
        {t.footer.privacy}
      </a>
      <a href={termsLink} class="text-[#4A5A66] text-xs font-['JetBrains_Mono',monospace] hover:text-[#C8A97E] transition-colors">
        {t.footer.terms}
      </a>
    </div>

    <p class="text-[#4A5A66] text-xs mt-6">
      {t.footer.copyright}
    </p>
  </footer>
</section>
